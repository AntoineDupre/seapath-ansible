---
- name: Verify
  hosts: all
  become: true
  gather_facts: false

  vars:
    # Adapte à tes vrais fichiers attendus dans /usr/local/bin
    expected_scripts:
      - /usr/local/bin/backup-restore.sh

    # Adapte aux templates rendus (scripts/*.j2 -> /usr/local/bin/<sans .j2>)
    expected_rendered_templates:
      - /usr/local/bin/backup-restore.conf

  tasks:
    - name: Debug owner
      ansible.builtin.command: stat -c "%U:%G" /usr/local/bin/backup-restore.sh
      register: owner_test
      changed_when: false
    
    - debug:
        var: owner_test.stdout

    - ansible.builtin.stat:
        path: /usr/local/bin/backup-restore.sh
      register: st
    
    - ansible.builtin.assert:
        that:
          - st.stat.uid == 0
          - st.stat.gid == 0


    - name: Stat expected scripts
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ expected_scripts }}"
      register: st_scripts


    - name: Assert scripts exist
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isreg
        fail_msg: "File {{ item.stat.path | default('unknown') }} does not exist"
      loop: "{{ st_scripts.results }}"
      loop_control:
        label: "{{ item.stat.path | default('unknown') }}"
    
    - name: Assert scripts ownership is root:root
      ansible.builtin.assert:
        that:
          - item.stat.pw_name | default('') == "root"
          - item.stat.gr_name | default('') == "root"
      loop: "{{ st_scripts.results }}"
      loop_control:
        label: "{{ item.stat.path | default('unknown') }}"

    - name: Stat rendered templates
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ expected_rendered_templates }}"
      register: st_tpl

    - name: Assert templates rendered and are executable (0755)
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isreg
          # mode retourné comme string (ex: "0755")
          - item.stat.mode == "0755"
      loop: "{{ st_tpl.results }}"
      loop_control:
        label: "{{ item.stat.path | default('unknown') }}"

    - name: Assert no .j2 files exist in /usr/local/bin
      ansible.builtin.shell: "ls -1 /usr/local/bin/*.j2 2>/dev/null || true"
      register: ls_j2
      changed_when: false

    - name: Assert .j2 list is empty
      ansible.builtin.assert:
        that:
          - ls_j2.stdout | trim == ""

    - name: Stat /etc/backup-restore.conf
      ansible.builtin.stat:
        path: /etc/backup-restore.conf
      register: st_conf

    - name: Assert /etc/backup-restore.conf exists with correct perms/owner
      ansible.builtin.assert:
        that:
          - st_conf.stat.exists
          - st_conf.stat.isreg
          - st_conf.stat.pw_name == "root"
          - st_conf.stat.gr_name == "root"
          - st_conf.stat.mode == "0644"

    - name: Count remote_shell="ssh" exact line
      ansible.builtin.shell: "grep -c '^remote_shell=\"ssh\"$' /etc/backup-restore.conf || true"
      register: cnt_remote_shell_ssh
      changed_when: false

    - name: Assert default remote_shell line is present exactly once
      ansible.builtin.assert:
        that:
          - (cnt_remote_shell_ssh.stdout | trim | int) == 1

    - name: Count any remote_shell= lines (avoid duplicates)
      ansible.builtin.shell: "grep -c '^remote_shell=' /etc/backup-restore.conf || true"
      register: cnt_remote_shell_any
      changed_when: false

    - name: Assert only one remote_shell= line exists
      ansible.builtin.assert:
        that:
          - (cnt_remote_shell_any.stdout | trim | int) == 1
